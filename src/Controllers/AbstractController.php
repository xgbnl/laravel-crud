<?php

namespace Xgbnl\Business\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use ReflectionException;
use Xgbnl\Business\Traits\BusinessGenerator;
use Xgbnl\Business\Utils\MagicMethods;
use ReflectionClass;

abstract class AbstractController extends Controller
{
    use BusinessGenerator;

    protected ?Request $request = null;

    public function callAction($method, $parameters)
    {
        $injected = false;

        foreach ($parameters as $p) {
            if ($p instanceof Request) {
                $this->request = $p;
                $injected      = true;
            }
        }

        if (!$injected) {
            $this->request = \request();
        }

        return parent::callAction($method, $parameters); // TODO: Change the autogenerated stub
    }

    /**
     * @throws ReflectionException
     */
    public function __call($method, $parameters)
    {
        $reflection = new ReflectionClass(MagicMethods::class);
        if (!$reflection->hasMethod($method)) {
            parent::__call($method, $parameters);
        }

        return $this->parseMethod($reflection, $method, $parameters);
    }

    /**
     * @throws ReflectionException
     */
    private function parseMethod(ReflectionClass $reflectionClass, string $method, array $parameters)
    {
        $magicMethod = $reflectionClass->getMethod($method);

        $params = [];

        foreach ($magicMethod->getParameters() as $key => $parameter) {

            if (isset($parameters[$parameter->getName()])) {

                $params[] = $parameters[$parameter->getName()];

            } elseif ($parameter->isDefaultValueAvailable() && !isset($parameters[$key])) {

                $params[] = $parameter->getDefaultValue();

            } elseif (isset($parameters[$key])) {

                $params[] = $parameters[$key];
            }
        }

        return $magicMethod->invoke(null, ...$params);
    }
}
